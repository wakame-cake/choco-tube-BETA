{% extends "base.html" %}

{% block title %}{{ video.title if video else 'å‹•ç”»' }} - ãƒãƒ§ã‚³Tube{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js" rel="preload" as="script">
{% endblock %}

{% block content %}
<div class="watch-container">
    <div class="watch-main">
        <div class="player-container">
            <div id="player-wrapper" class="player-wrapper">
                {% if mode == 'embed' %}
                <iframe id="embed-player" class="embed-player"
                        src="{{ streams.embed }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                {% elif mode == 'education' %}
                <iframe id="embed-player" class="embed-player"
                        src="{{ streams.education }}"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen></iframe>
                {% elif mode == 'high' and video and video.highstreamUrl %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg">
                    <source src="{{ video.highstreamUrl }}" type="video/webm">
                </video>
                {% elif video and video.videoUrls %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg">
                    {% for url in video.videoUrls %}
                    <source src="{{ url }}" type="video/mp4">
                    {% endfor %}
                </video>
                {% elif streams.primary %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg">
                    <source src="{{ streams.primary }}" type="video/mp4">
                </video>
                {% elif streams.m3u8 %}
                <video id="video-player" class="video-player" controls autoplay playsinline
                       poster="https://i.ytimg.com/vi/{{ video_id }}/maxresdefault.jpg"></video>
                {% else %}
                <div class="player-error">
                    <div class="error-content">
                        <span class="error-icon">âš ï¸</span>
                        <h3>å†ç”Ÿã§ãã¾ã›ã‚“ã§ã—ãŸ</h3>
                        <p>å‹•ç”»ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚<br>ä»¥ä¸‹ã®ã®å†ç”Ÿãƒ¢ãƒ¼ãƒ‰ã©ã¡ã‚‰ã‹ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚</p>
                        <div class="error-actions">
                            <a href="/watch?v={{ video_id }}" class="error-btn primary">ğŸ¬ ã‚¹ãƒˆãƒªãƒ¼ãƒ ã§å†ç”Ÿ</a>
                            <a href="/edu?v={{ video_id }}" class="error-btn">ğŸ“ Educationã§å†ç”Ÿ</a>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="player-controls">
                <a href="/watch?v={{ video_id }}" class="player-source-btn {% if mode == 'stream' %}active{% endif %}">
                    <span>ğŸ¬ ã‚¹ãƒˆãƒªãƒ¼ãƒ </span>
                </a>
                <a href="/w?v={{ video_id }}" class="player-source-btn {% if mode == 'high' %}active{% endif %}">
                    <span>ğŸ“º é«˜ç”»è³ª</span>
                </a>
                <a href="/ume?v={{ video_id }}" class="player-source-btn {% if mode == 'embed' %}active{% endif %}">
                    <span>ğŸ”— åŸ‹ã‚è¾¼ã¿</span>
                </a>
                <a href="/edu?v={{ video_id }}" class="player-source-btn {% if mode == 'education' %}active{% endif %}">
                    <span>ğŸ“ Education</span>
                </a>
            </div>

            {% if video and video.streamUrls %}
            <div class="resolution-selector">
                <label for="resolutionSelect">ç”»è³ªé¸æŠ:</label>
                <select id="resolutionSelect">
                    {% for stream in video.streamUrls %}
                    <option value="{{ stream.url }}">{{ stream.resolution }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}
        </div>

        {% if video %}
        <div class="video-details">
            <h1 class="video-title">{{ video.title }}</h1>
            <div class="video-stats">
                <span class="views">{{ video.views }} å›è¦–è´</span>
                <span class="separator">â€¢</span>
                <span class="published">{{ video.published }}</span>
                <span class="likes">ğŸ‘ {{ video.likes }}</span>
            </div>

            <div class="channel-info">
                {% if video.authorThumbnail %}
                <img src="{{ video.authorThumbnail }}" alt="{{ video.author }}" class="channel-avatar">
                {% endif %}
                <div class="channel-details">
                    <a href="/channel/{{ video.authorId }}" class="channel-name">{{ video.author }}</a>
                    {% if video.subscribers %}
                    <span class="subscribers">{{ video.subscribers }} äºº</span>
                    {% endif %}
                </div>
            </div>

            <div class="description">
                <div class="description-content" id="description">
                    {{ video.description|safe }}
                </div>
                <button class="description-toggle" id="desc-toggle">ã‚‚ã£ã¨è¦‹ã‚‹</button>
            </div>

            <div class="player-options">
                <label class="option-label">
                    <input type="checkbox" id="loopToggle">
                    ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
                </label>
                <label class="option-label">
                    <input type="checkbox" id="autoNextToggle">
                    è‡ªå‹•ã§æ¬¡ã®å‹•ç”»ã¸
                </label>
            </div>

            {% if video.videoUrls and video.videoUrls[0] %}
            <div class="download-section">
                <a href="{{ video.videoUrls[0] }}" download="{{ video.title }}" class="download-btn">
                    â¬‡ï¸ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
            {% endif %}
        </div>

        <div class="comments-section">
            <h3 class="comments-title">ã‚³ãƒ¡ãƒ³ãƒˆ</h3>
            <div class="comments-list" id="comments">
                {% for comment in comments %}
                <div class="comment">
                    <img src="{{ comment.authorThumbnail }}" alt="{{ comment.author }}" class="comment-avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <a href="/channel/{{ comment.authorId }}" class="comment-author">{{ comment.author }}</a>
                            <span class="comment-date">{{ comment.published }}</span>
                        </div>
                        <div class="comment-text">{{ comment.content|safe }}</div>
                        <div class="comment-actions">
                            <span class="comment-likes">ğŸ‘ {{ comment.likes }}</span>
                        </div>
                    </div>
                </div>
                {% else %}
                <p class="no-comments">ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>

    <aside class="watch-sidebar">
        <h3 class="sidebar-title">é–¢é€£å‹•ç”»</h3>
        <div class="related-videos">
            {% if video and video.related %}
            {% for related in video.related %}
            <a href="/watch?v={{ related.id }}" class="related-card">
                <div class="related-thumbnail-container">
                    <img src="/thumbnail?v={{ related.id }}" alt="{{ related.title }}" class="related-thumbnail" loading="lazy">
                    {% if related.length %}
                    <span class="video-duration">{{ related.length }}</span>
                    {% endif %}
                </div>
                <div class="related-info">
                    <h4 class="related-title">{{ related.title }}</h4>
                    <a href="/channel/{{ related.authorId }}" class="related-author">{{ related.author }}</a>
                    <p class="related-views">{{ related.views }}</p>
                </div>
            </a>
            {% endfor %}
            {% endif %}
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.12/dist/hls.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const videoId = '{{ video_id }}';
    const m3u8Url = '{{ streams.m3u8|default("", true) }}';
    const mode = '{{ mode }}';

    const video = document.getElementById('video-player');
    let retryCount = 0;
    const maxRetries = 3;
    let errorTimeout = null;
    let hasPlayedSuccessfully = false;
    let isRetrying = false;
    let fallbackShown = false;
    let hlsInstance = null;
    let stalledTimeout = null;
    let initialLoadTimeout = null;

    function showReloadNotification(message) {
        let notification = document.getElementById('reload-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'reload-notification';
            notification.style.cssText = 'position: fixed; top: 80px; left: 50%; transform: translateX(-50%); background: rgba(139, 69, 19, 0.95); color: white; padding: 16px 24px; border-radius: 8px; z-index: 9999; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 12px;';
            document.body.appendChild(notification);
        }
        notification.innerHTML = '<span style="animation: spin 1s linear infinite; display: inline-block;">ğŸ”„</span> ' + message;
        notification.style.display = 'flex';
        
        if (!document.querySelector('style[data-reload-animation]')) {
            const style = document.createElement('style');
            style.textContent = '@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
            style.setAttribute('data-reload-animation', 'true');
            document.head.appendChild(style);
        }
    }

    function hideReloadNotification() {
        const notification = document.getElementById('reload-notification');
        if (notification) {
            notification.style.display = 'none';
        }
    }

    function clearAllTimeouts() {
        clearTimeout(errorTimeout);
        clearTimeout(stalledTimeout);
        clearTimeout(initialLoadTimeout);
        errorTimeout = null;
        stalledTimeout = null;
        initialLoadTimeout = null;
    }

    function resetRetryState() {
        retryCount = 0;
        isRetrying = false;
        clearAllTimeouts();
        hideReloadNotification();
    }

    function destroyHlsInstance() {
        if (hlsInstance) {
            hlsInstance.destroy();
            hlsInstance = null;
        }
    }

    function handleVideoError() {
        if (hasPlayedSuccessfully || isRetrying || fallbackShown) return;
        
        isRetrying = true;
        clearAllTimeouts();
        retryCount++;
        
        if (retryCount <= maxRetries) {
            showReloadNotification('å†ç”Ÿã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ... å†èª­ã¿è¾¼ã¿ä¸­ (' + retryCount + '/' + maxRetries + ')');
            
            errorTimeout = setTimeout(function() {
                isRetrying = false;
                
                if (video) {
                    destroyHlsInstance();
                    
                    if (m3u8Url && Hls.isSupported()) {
                        initHls();
                    } else {
                        const sources = video.querySelectorAll('source');
                        if (sources.length > 0) {
                            video.load();
                            video.play().catch(function() {});
                        } else if (video.src) {
                            const currentSrc = video.src;
                            video.src = '';
                            video.src = currentSrc;
                            video.load();
                            video.play().catch(function() {});
                        }
                    }
                }
            }, 2000);
        } else {
            isRetrying = false;
            hideReloadNotification();
            showFallbackOptions();
        }
    }

    function showFallbackOptions() {
        if (fallbackShown) return;
        fallbackShown = true;
        
        let fallbackDiv = document.getElementById('fallback-options');
        if (fallbackDiv) {
            fallbackDiv.remove();
        }
        
        fallbackDiv = document.createElement('div');
        fallbackDiv.id = 'fallback-options';
        fallbackDiv.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-card, #1a1a2e); border: 1px solid var(--border-color, #2a2a4a); padding: 24px; border-radius: 12px; z-index: 9999; text-align: center; max-width: 400px;';
        
        const title = document.createElement('h3');
        title.style.cssText = 'margin-bottom: 16px; color: var(--text-primary, #fff);';
        title.textContent = 'å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ';
        fallbackDiv.appendChild(title);
        
        const description = document.createElement('p');
        description.style.cssText = 'margin-bottom: 20px; color: var(--text-secondary, #b8b8c8);';
        description.textContent = 'åˆ¥ã®ãƒ¢ãƒ¼ãƒ‰ã§å†ç”Ÿã‚’ãŠè©¦ã—ãã ã•ã„';
        fallbackDiv.appendChild(description);
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; flex-direction: column; gap: 12px;';
        
        const buttonStyle = 'padding: 12px 24px; background: #8b4513; color: white; text-decoration: none; border-radius: 8px; display: block;';
        
        if (mode !== 'embed') {
            const embedLink = document.createElement('a');
            embedLink.href = '/ume?v=' + videoId;
            embedLink.style.cssText = buttonStyle;
            embedLink.textContent = 'ğŸ”— åŸ‹ã‚è¾¼ã¿ãƒ¢ãƒ¼ãƒ‰ã§å†ç”Ÿ';
            buttonContainer.appendChild(embedLink);
        }
        if (mode !== 'education') {
            const eduLink = document.createElement('a');
            eduLink.href = '/edu?v=' + videoId;
            eduLink.style.cssText = buttonStyle;
            eduLink.textContent = 'ğŸ“ Educationãƒ¢ãƒ¼ãƒ‰ã§å†ç”Ÿ';
            buttonContainer.appendChild(eduLink);
        }
        if (mode !== 'stream') {
            const streamLink = document.createElement('a');
            streamLink.href = '/watch?v=' + videoId;
            streamLink.style.cssText = buttonStyle;
            streamLink.textContent = 'ğŸ¬ ã‚¹ãƒˆãƒªãƒ¼ãƒ ãƒ¢ãƒ¼ãƒ‰ã§å†ç”Ÿ';
            buttonContainer.appendChild(streamLink);
        }
        
        const reloadBtn = document.createElement('button');
        reloadBtn.style.cssText = 'padding: 12px 24px; background: var(--bg-secondary, #16213e); border: 1px solid var(--border-color, #2a2a4a); color: var(--text-primary, #fff); border-radius: 8px; cursor: pointer;';
        reloadBtn.textContent = 'ğŸ”„ ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿';
        reloadBtn.addEventListener('click', function() { location.reload(); });
        buttonContainer.appendChild(reloadBtn);
        
        const closeBtn = document.createElement('button');
        closeBtn.style.cssText = 'padding: 8px 16px; background: transparent; border: none; color: var(--text-secondary, #b8b8c8); cursor: pointer;';
        closeBtn.textContent = 'é–‰ã˜ã‚‹';
        closeBtn.addEventListener('click', function() {
            fallbackDiv.style.display = 'none';
        });
        buttonContainer.appendChild(closeBtn);
        
        fallbackDiv.appendChild(buttonContainer);
        document.body.appendChild(fallbackDiv);
    }

    function initHls() {
        if (!video || !m3u8Url) return;
        
        destroyHlsInstance();
        
        hlsInstance = new Hls({
            maxBufferLength: 30,
            maxMaxBufferLength: 60,
            startLevel: -1
        });
        hlsInstance.loadSource(m3u8Url);
        hlsInstance.attachMedia(video);
        
        hlsInstance.on(Hls.Events.ERROR, function(event, data) {
            if (data.fatal) {
                destroyHlsInstance();
                handleVideoError();
            }
        });
        
        hlsInstance.on(Hls.Events.MANIFEST_PARSED, function() {
            video.play().catch(function() {});
        });
    }

    if (video && m3u8Url && !video.querySelector('source')) {
        if (Hls.isSupported()) {
            initHls();
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = m3u8Url;
        }
    }

    if (video) {
        video.addEventListener('error', function(e) {
            console.log('Video error:', e);
            handleVideoError();
        });
        
        video.addEventListener('stalled', function() {
            console.log('Video stalled');
            if (!hasPlayedSuccessfully && !isRetrying && video.currentTime < 1) {
                clearTimeout(stalledTimeout);
                stalledTimeout = setTimeout(function() {
                    if (!hasPlayedSuccessfully && !isRetrying && video.currentTime < 1 && video.readyState < 3) {
                        handleVideoError();
                    }
                }, 8000);
            }
        });
        
        video.addEventListener('playing', function() {
            hasPlayedSuccessfully = true;
            resetRetryState();
        });
        
        video.addEventListener('canplay', function() {
            hideReloadNotification();
            clearTimeout(stalledTimeout);
            clearTimeout(initialLoadTimeout);
        });
        
        initialLoadTimeout = setTimeout(function() {
            if (video && !hasPlayedSuccessfully && !isRetrying && video.readyState < 2) {
                handleVideoError();
            }
        }, 10000);
    }

    const descToggle = document.getElementById('desc-toggle');
    const description = document.getElementById('description');
    if (descToggle && description) {
        descToggle.addEventListener('click', function() {
            description.classList.toggle('expanded');
            this.textContent = description.classList.contains('expanded') ? 'é–‰ã˜ã‚‹' : 'ã‚‚ã£ã¨è¦‹ã‚‹';
        });
    }

    const loopToggle = document.getElementById('loopToggle');
    const autoNextToggle = document.getElementById('autoNextToggle');

    function getCookie(name) {
        const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
        return v ? decodeURIComponent(v.pop()) : null;
    }

    function setCookie(name, value, days) {
        const d = new Date();
        d.setTime(d.getTime() + (days || 30) * 24 * 60 * 60 * 1000);
        document.cookie = name + '=' + encodeURIComponent(value) + ';expires=' + d.toUTCString() + ';path=/';
    }

    if (loopToggle && video) {
        loopToggle.checked = getCookie('loop') === 'true';
        video.loop = loopToggle.checked;

        loopToggle.addEventListener('change', function() {
            video.loop = this.checked;
            setCookie('loop', this.checked, 30);
        });
    }

    if (autoNextToggle) {
        autoNextToggle.checked = getCookie('autonext') === 'true';

        autoNextToggle.addEventListener('change', function() {
            setCookie('autonext', this.checked, 30);
        });
    }

    if (video) {
        video.addEventListener('ended', function() {
            if (getCookie('autonext') === 'true') {
                {% if video and video.related and video.related|length > 0 %}
                setTimeout(function() {
                    window.location.href = '/watch?v={{ video.related[0].id }}';
                }, 3000);
                {% endif %}
            }
        });
    }

    const resolutionSelect = document.getElementById('resolutionSelect');
    if (resolutionSelect && video) {
        resolutionSelect.addEventListener('change', function() {
            const currentTime = video.currentTime;
            const isPaused = video.paused;

            video.src = this.value;
            video.currentTime = currentTime;
            if (!isPaused) {
                video.play();
            }
        });
    }

    document.addEventListener('keydown', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        if (video && (e.keyCode === 32 || e.keyCode === 75)) {
            e.preventDefault();
            if (video.paused) {
                video.play();
            } else {
                video.pause();
            }
        }
    });
});
</script>
{% endblock %}
